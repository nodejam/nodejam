utils = require('../common/utils')
console = require 'console'
AppError = require('../common/apperror').AppError

class Validator

    constructor: ->
        
        

    validate: (model, fields, cb) =>
        errors = []

        for fieldName, def of fields
            @validateField(model[fieldName], fieldName, model, def)
            
                

    validateField: (value, fieldName, model, def) =>
        errors = []

        if not def.useCustomValidationOnly                
            #Convert short hands to full definitions.
            #eg: 'string' means { type: 'string', required: true }
            if ['string', 'number', 'boolean', 'object'].indexOf(def) isnt -1
                fieldDef = {
                    type: def,
                    required: true
                }
            else if def is 'array'
                fieldDef = {
                    type: 'array',
                    required: true
                }
            else if def.autoGenerated and (def.event is 'created' or def.event is 'updated')
                fieldDef = {
                    type: 'number',
                    required: true
                }
            else
                fieldDef = def

            #Required is true unless explicitly set.
            if not fieldDef.required?
                fieldDef.required = true

            #Check types.            
            if fieldDef.type is 'array'
                for item in value
                    errors.push @validateField item, '', null, fieldDef.contents
            else
                #If it is a custom class
                if (@isCustomClass(type) and value.constructor isnt type) or (typeof(value) isnt fieldDef.type)
                    errors.push "#{fieldName} should be a #{fieldDef.type}."                        

        if def.validate
            errors.push def.validate.call model
        
        return errors
                
            

    isCustomClass: (type) ->
        ['string', 'number', 'boolean', 'object', 'array', ''].indexOf(type) is -1

exports.Validator = Validator
