(function() {
    "use strict";

    var _;

    var odm = require('fora-models');

    var ForaTypesServiceBase = function() {
        odm.TypeUtils.apply(this, arguments);
    };

    ForaTypesServiceBase.prototype = Object.create(odm.TypeUtils.prototype);
    ForaTypesServiceBase.prototype.constructor = ForaTypesServiceBase;


    ForaTypesServiceBase.prototype.init = function*(builtinTypes, RecordType) {
        this.builtinTypes = builtinTypes;
        this.RecordType = RecordType;
        _ = yield* this.buildTypeCache(builtinTypes, RecordType);
    };


    ForaTypesServiceBase.prototype.getCacheItems = function*() {
        var definitions = {};

        [yield* this.getModelTypeDefinitions(), yield* this.getBuiltInUserTypes()].forEach(function(defs) {
            for (var name in defs) {
                var def = defs[name];
                definitions[name] = def;
            }
        });

        return definitions;
    };


    ForaTypesServiceBase.prototype.getModelTypeDefinitions = function*() {
        var models = [];

        var fnAdd = function(module) {
            for (var name in module) {
                var model = module[name];
                models.push(model);
                if (model.childModels)
                    fnAdd(model.childModels);
            }
        };

        this.builtinTypes.forEach(function(t) { fnAdd(t); });

        var definitions = {};

        models.forEach(function(model) {
            var def = typeof model.typeDefinition === "function" ? model.typeDefinition() : model.typeDefinition;
            def = this.completeTypeDefinition(def, model);
            definitions[def.name] = definitions[def.name] || def;
        }, this);

        return definitions;
    };

    ForaTypesServiceBase.prototype.getBuiltInUserTypes = function*() {
        var definitions = {};
        _ = yield* this.addTrustedUserTypes(this.RecordType, 'record', 'records', definitions);
        return definitions;
    };


    ForaTypesServiceBase.prototype.addTrustedUserTypes = function*() {
        throw new Error("addTrustedUserTypes() method must be overridden in derived class.");
    };


    ForaTypesServiceBase.prototype.mergeUserTypeDefinition = function(ext, ctor, baseTypeName, dir, typeName, version, typeDef) {
        var def = JSON.parse(JSON.stringify(ext.typeDefinition));

        if (typeDef.initialize)
            def.initialize = typeDef.initialize;

        def.type = baseTypeName;
        def.name = dir + "/" + typeName + "/" + version;
        def.version = version;
        def.extensionType = 'builtin';

        ['collection', 'trackChanges', 'autoGenerated', 'logging'].forEach(function(field) {
            def[field] = typeDef[field];
        });

        def.ctor = ctor;

        def.inheritedProperties = [];

        for (var k in typeDef.schema.properties) {
            v = typeDef.schema.properties[k];
            def.schema.properties[k] = v;
            def.inheritedProperties.push(k);
        }

        typeDef.schema.required.forEach(function(req) {
            if (def.schema.required && def.schema.required.indexOf(req) === -1)
                def.schema.required.push(req);
        });
        return def;
    };


    ForaTypesServiceBase.prototype.resolveDynamicTypeDefinition = function*(name) {
        //TODO: make sure we dont allow special characters in name, like '..'
        console.log("Missing " + JSON.stringify(name));
    };

    module.exports = ForaTypesServiceBase;

})();
